---
title: "PESI analysis with brms"
author: "I. S. Plank"
date: "`r Sys.Date()`"
output: html_document
---

```{r settings, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
ls.packages = c("knitr",            # kable
                "ggplot2",          # plots
                "brms",             # Bayesian lmms
                "designr",          # simLMM
                "bridgesampling",   # bridge_sampler
                "tidyverse",        # tibble stuff
                "ggpubr",           # ggarrange
                "ggrain",           # geom_rain
                "bayesplot",        # plots for posterior predictive checks
                "SBC",              # plots for checking computational faithfulness
                "rstatix",          # anova
                "BayesFactor"
                )

lapply(ls.packages, library, character.only=TRUE)

# set cores
options(mc.cores = parallel::detectCores())

# set file paths
fl.path = '/home/emba/Documents/PESI'
dt.path = paste(fl.path, 'BVET', sep = "/")

knitr::opts_knit$set(root.dir = '/home/emba/Documents/PESI/PESI_scripts')

# graph settings 
c_light = "#a9afb2"; c_light_highlight = "#8ea5b2"; c_mid = "#6b98b2" 
c_mid_highlight = "#3585b2"; c_dark = "#0072b2"; c_dark_highlight = "#0058b2" 
c_green = "#009E73"
c_dark_green = "#006f50"
sz = 1

```

<style type="text/css">
.main-container {
  max-width: 1100px;
  margin-left: auto;
  margin-right: auto;
}
</style>

## Package versions

```{r lib_versions, echo=F}

print(R.Version()$version.string)

for (package in ls.packages) {
  print(sprintf("%s version %s", package, packageVersion(package)))
}

```

## Introduction and preparation

# Demographic information

```{r demo, warning=F, message=F}



```

# Behavioural data

```{r load_bv, warning=F, message=F}

# load the relevant data in long format
df.beh = list.files(path = dt.path, pattern = "PESI-BV", full.names = T) %>%
  map_df(~read_delim(., show_col_types = F, delim = ",",
                     col_types = "cddcccddddd")) %>%
  select(-dyad)

# load the stimulus description file
df.stm = read_csv(paste(fl.path, "PESI_videosel-full_230404.csv", sep = "/"), show_col_types = F) %>%
  mutate(
    video = sprintf("PESI_%s_%08d", substr(dyad,1,3), frame_sta)
  ) %>%
  select(video, dyad, context, mot, peak)

# merge together
df = merge(df.beh, df.stm, all.x = T, by = "video") %>%
  mutate(
         rating.confirmed = case_when(
           confirmed == 1 ~ rating)  # convert to percentages if rating was confirmed
         ) %>%
  arrange(subID, trl) %>%
  mutate_if(is.character, as.factor)

# how many participants? 
nrow(df %>% select(subID) %>% distinct())

# exclude participants with more than 33% of trials missing
df = df %>%
  group_by(subID) %>%
  mutate(
    total = sum(confirmed)/64
  ) %>%
  filter(total > 2/3)
  
# how many participants left? 
nrow(df %>% select(subID) %>% distinct())

```
